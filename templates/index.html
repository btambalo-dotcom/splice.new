
{% extends 'base.html' %}
{% block title %}Leitor Twelve Tech{% endblock %}
{% block content %}
<h3 class="mb-3">Leitor Twelve Tech · Produção</h3>

<div class="row mb-4 g-3">
  <div class="col-md-4">
    <div class="card p-3">
      <span class="text-secondary">Registros no banco</span>
      <h2 class="mb-0">{{ total_rows }}</h2>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3">
      <span class="text-secondary">Valor total acumulado (USD)</span>
      <h2 class="mb-0">$ {{ '%.2f'|format(total_amount or 0) }}</h2>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3">
      <span class="text-secondary">Formato aceito</span>
      <h2 class="mb-0">.xlsx</h2>
    </div>
  </div>
</div>

<div class="row g-4">
    <div class="card p-4">
      
      <h5>Filtros</h5>
      <form method="get" class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Empresa</label>
          <select name="company" class="form-control">
            <option value="">Todas</option>
            {% for c in companies %}
              <option value="{{ c }}" {% if company_filter == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Splicer / Usuário</label>
          {% if current_user.is_admin %}
          <select name="splicer" class="form-control">
            <option value="">Todos</option>
            {% for s in splicers %}
              <option value="{{ s }}" {% if splicer_filter == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
          {% else %}
          <input class="form-control" value="{{ current_user.splicer_name or current_user.username }}" disabled>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Map</label>
          <input name="map" class="form-control" value="{{ map_filter }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data início</label>
          <input type="date" name="start" class="form-control" value="{{ start }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data fim</label>
          <input type="date" name="end" class="form-control" value="{{ end }}">
        </div>
        <div class="col-md-12">
          <button class="btn btn-outline-light w-100 mt-2">Aplicar filtros</button>
        </div>
      </form>
mb-3">Registros</h5>
  
  <div class="mb-2 text-end">
    <a class="btn btn-sm btn-outline-info me-2"
       href="{{ url_for('export_pdf', company=company_filter, splicer=splicer_filter, map=map_filter, start=start, end=end) }}">
      PDF com valores
    </a>
    <a class="btn btn-sm btn-outline-secondary me-2"
       href="{{ url_for('export_pdf', company=company_filter, splicer=splicer_filter, map=map_filter, start=start, end=end, no_values=1) }}">
      PDF sem valores
    </a>
    <a class="btn btn-sm btn-warning"
       href="{{ url_for('export_invoice', company=company_filter, splicer=splicer_filter, map=map_filter, start=start, end=end) }}">
      Generate invoice (PDF)
    </a>
    <a class="btn btn-sm btn-success"
       href="{{ url_for('export_excel', company=company_filter, splicer=splicer_filter, map=map_filter, start=start, end=end) }}">
      Export Excel
    </a>
  </div>


  <div class="table-responsive" style="max-height: 60vh;">
    <table class="table table-sm table-dark align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Data</th>
          <th>Empresa</th>
          <th>Map</th>
          <th>Type</th>
          <th>Device</th>
          <th>Splices</th>
          <th>$ Fusões</th>
          <th>$ Device</th>
          <th>$ Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for r in records %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.created_date.date() if r.created_date else '' }}</td>
            <td>{{ r.company or '-' }}</td>
            <td>{{ r.map }}</td>
            <td>{{ r.type }}</td>
            <td>{{ r.device }}</td>
            <td>{{ r.splices }}</td>
            <td>$ {{ '%.2f'|format(r.price_splices_usd or 0) }}</td>
            <td>$ {{ '%.2f'|format(r.price_device_usd or 0) }}</td>
            <td>$ {{ '%.2f'|format(r.total_usd or 0) }}</td>
            <td class="text-end">
              <a href="{{ url_for('record_delete', rid=r.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Excluir este registro?');">✕</a>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="11" class="text-center text-secondary">Nenhum registro encontrado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}